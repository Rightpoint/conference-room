<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, height=device-height, target-densitydpi=device-dpi">

  <title>Room Ninja</title>

  <!-- bower:css -->
  <!-- endbower -->

  <!-- inject:css -->
  <!-- endinject -->
</head>

<body>

  <div class="container-fluid main-content" ui-view>
  </div> <!-- /container -->


  <!-- bower:js -->
  <!-- endbower -->

  <!-- inject:js -->
  <!-- endinject -->

  <script type="text/javascript">
    angular.element(document).ready(function() {
      // OPTION 1: get token from hash
      var authToken = (window.location.hash || '').substring(1);
      if(authToken.indexOf('/') >= 0) {
        authToken = null; // it's a URL, not a token
      }

      // OPTION 2: local storage (will be useful for local testing)
      authToken = authToken || (window.localStorage || { getItem: function() {} }).getItem('authToken');


      // OPTION 3: POST to /api/tokens/get to get one
      if(!authToken) {
        var r = new XMLHttpRequest();
        r.onreadystatechange = function() { 
          if(r.readyState == XMLHttpRequest.DONE) {
            if(r.status === 200) {
              authToken = r.responseText;
              finishBootstrap();
            } else {
              console.log('error getting token');
              console.log(r.responseText);
              finishBootstrap();
            }
          } 
        }
        r.open('POST', '/api/tokens/get');
        r.send(null);
      } else {
        finishBootstrap();
      }

      function finishBootstrap() {
        // OPTION 4: redirect to /azure-ad-auth (which will log the user in and redirect them back here, which will make OPTION 2 work)
        if(!authToken) {
          window.location = '/azure-ad-auth';
          return;
        }

        angular.module('app').value('authToken', authToken);
        angular.bootstrap(document, ['app']);
      }
    });
  </script>
</body>
</html>